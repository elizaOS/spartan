#!/bin/bash

# Multi-Chain Mini App Test Runner
# This script installs dependencies and runs all tests

set -e  # Exit on error

BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘     Eliza Multi-Chain Mini App - Test Runner        â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Navigate to project directory
cd "$(dirname "$0")"
PROJECT_DIR=$(pwd)

echo -e "${BLUE}ğŸ“‚ Project: ${PROJECT_DIR}${NC}"
echo ""

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}ğŸ“¦ Installing dependencies...${NC}"
    npm install
    echo -e "${GREEN}âœ… Dependencies installed${NC}"
    echo ""
else
    echo -e "${GREEN}âœ… Dependencies already installed${NC}"
    echo ""
fi

# Run TypeScript check
echo -e "${BLUE}ğŸ” Checking TypeScript types...${NC}"
npx tsc --noEmit --skipLibCheck 2>&1 | head -20 || echo -e "${YELLOW}âš ï¸  Some TypeScript warnings (non-critical)${NC}"
echo ""

# Run tests with mocks (default)
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘              Running Tests (Mock Mode)               â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Run vitest
npm test -- --run --reporter=verbose 2>&1

TEST_EXIT_CODE=$?

echo ""
if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘              âœ… ALL TESTS PASSED! âœ…                  â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Generate coverage
    echo -e "${BLUE}ğŸ“Š Generating coverage report...${NC}"
    npm run test:coverage -- --run 2>&1 || echo -e "${YELLOW}Coverage generation skipped${NC}"
    
    echo ""
    echo -e "${GREEN}ğŸ‰ Test suite complete!${NC}"
    echo ""
    echo -e "${BLUE}Next steps:${NC}"
    echo -e "  â€¢ View coverage: ${YELLOW}open coverage/index.html${NC}"
    echo -e "  â€¢ Build app: ${YELLOW}npm run build${NC}"
    echo -e "  â€¢ Start dev: ${YELLOW}npm run dev${NC}"
else
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘              âŒ SOME TESTS FAILED âŒ                  â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Troubleshooting:${NC}"
    echo -e "  â€¢ Run in UI mode: ${YELLOW}npm run test:ui${NC}"
    echo -e "  â€¢ Check logs above for details"
    echo -e "  â€¢ See __tests__/README.md for help"
    exit 1
fi

